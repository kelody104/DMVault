<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WebRTC P2P Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #log { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .controls { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>WebRTC P2P 通信テスト</h1>
    
    <div class="controls">
        <label>Player ID: <input type="text" id="playerId" value="player1"></label>
        <button id="startBtn">マッチング開始</button>
    </div>

    <div id="log"></div>

    <div class="controls">
        <input type="text" id="msgInput" placeholder="メッセージを入力" disabled>
        <button id="sendBtn" disabled>送信</button>
    </div>

    <script src="P2PManager.js"></script>
    <script>
        const log = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const sendBtn = document.getElementById('sendBtn');
        const msgInput = document.getElementById('msgInput');
        const playerIdInput = document.getElementById('playerId');

        let p2p = null;

        function addLog(msg) {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        startBtn.onclick = () => {
            const playerId = playerIdInput.value;
            p2p = new P2PManager(playerId);
            
            // ログのオーバーライド
            const originalOnMessage = p2p.onMessage;
            p2p.onMessage = (data) => {
                addLog(`受信: ${JSON.stringify(data)}`);
            };

            // 接続完了時の処理を簡易的にチェック
            const checkDataChannel = setInterval(() => {
                if (p2p.dataChannel && p2p.dataChannel.readyState === 'open') {
                    addLog('P2P 接続が確立されました！');
                    msgInput.disabled = false;
                    sendBtn.disabled = false;
                    clearInterval(checkDataChannel);
                }
            }, 1000);

            p2p.startMatching();
            addLog(`${playerId} でマッチングを開始しました...`);
            startBtn.disabled = true;
            playerIdInput.disabled = true;
        };

        sendBtn.onclick = () => {
            const msg = msgInput.value;
            if (msg && p2p) {
                p2p.send('chat', { text: msg });
                addLog(`送信: ${msg}`);
                msgInput.value = '';
            }
        };
    </script>
</body>
</html>
