<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>WebRTC P2P Test</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        #log {
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }

        .controls {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>SkyWay P2P 通信テスト</h1>

    <div class="controls">
        <label>Auth Token: <input type="password" id="authToken" placeholder="SkyWay Auth Token"></label><br>
        <label>Room Name: <input type="text" id="roomName" value="dmvault-room"></label>
        <label>Member Name: <input type="text" id="memberName" value="player1"></label>
        <button id="startBtn">ルームに参加</button>
    </div>

    <div id="log"></div>

    <div class="controls">
        <input type="text" id="msgInput" placeholder="メッセージを入力" disabled>
        <button id="sendBtn" disabled>送信</button>
    </div>

    <!-- SkyWay SDK Core -->
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/core/dist/skyway_core.js"></script>
    <script src="P2PManager.js"></script>
    <script>
        const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = skyway_sdk;

        const log = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const sendBtn = document.getElementById('sendBtn');
        const msgInput = document.getElementById('msgInput');

        const tokenInput = document.getElementById('authToken');
        const roomNameInput = document.getElementById('roomName');
        const memberNameInput = document.getElementById('memberName');

        let p2p = null;

        function addLog(msg) {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        startBtn.onclick = async () => {
            const token = tokenInput.value;
            const roomName = roomNameInput.value;
            const memberName = memberNameInput.value;

            if (!token) {
                alert('Auth Token を入力してください。');
                return;
            }

            p2p = new P2PManager(null, token);

            p2p.onConnected = () => {
                addLog('SkyWay 接続完了。対戦相手を待っています...');
                msgInput.disabled = false;
                sendBtn.disabled = false;
            };

            p2p.onMessageReceived = (data) => {
                addLog(`受信: ${data}`);
            };

            try {
                addLog('接続中...');
                await p2p.joinRoom(roomName, memberName);
                startBtn.disabled = true;
                tokenInput.disabled = true;
                roomNameInput.disabled = true;
                memberNameInput.disabled = true;
            } catch (e) {
                addLog(`エラー: ${e.message}`);
            }
        };

        sendBtn.onclick = () => {
            const msg = msgInput.value;
            if (msg && p2p) {
                p2p.send('chat', { text: msg });
                addLog(`送信: ${msg}`);
                msgInput.value = '';
            }
        };
    </script>
</body>

</html>